
<!DOCTYPE html>
<html lang="en-us">

    <head>

        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        
        <meta property="og:title" content="Apache Pinot: Geospatial - java.nio.BufferUnderflowException: null | Mark Needham" />
        <meta property="og:site_name" content="Mark Needham" />
        <meta property="og:url" content="https://www.markhneedham.com/blog/2023/03/10/apache-pinot-geospatial-buffer-underflow/" />

    
        <meta property="og:type" content="article" />
        <meta property="og:article:published_time" content="2023-03-10T02:44:37Z" />
        <meta property="og:article:tag" content="pinot" />
        

        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:site" content="@markhneedham" />
        <meta name="twitter:creator" content="@markhneedham" />
        <meta name="twitter:title" content="Apache Pinot: Geospatial - java.nio.BufferUnderflowException: null" />
        
          <meta name="twitter:description" content="In this post we&#39;ll learn about the BufferUnderflowException when storing Geospatial points in Apache Pinot." />
        
        <meta name="twitter:url" content="https://www.markhneedham.com/blog/2023/03/10/apache-pinot-geospatial-buffer-underflow/" />

      
        
        <meta name="og:image" content="https://www.markhneedham.com/blog//uploads/2023/03/geospatial-underflow-banner.png" />
        <meta name="image" property="og:image" content="https://www.markhneedham.com/blog//uploads/2023/03/geospatial-underflow-banner.png">
        <meta name="twitter:image:src" content="https://www.markhneedham.com/blog//uploads/2023/03/geospatial-underflow-banner.png" />
        <meta name="twitter:image" content="https://www.markhneedham.com/blog//uploads/2023/03/geospatial-underflow-banner.png" />
      

    

        
        <title>Apache Pinot: Geospatial - java.nio.BufferUnderflowException: null | Mark Needham</title>

    
        <meta name="description" content="In this post we&#39;ll learn about the BufferUnderflowException when storing Geospatial points in Apache Pinot." />
    

        <meta name="p:domain_verify" content="fc173d84e3a4de948ed4bda2908afd3e"/>
        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        
        

        
        
        <link href="https://www.markhneedham.com/blog/index.xml" rel="alternate" type="application/rss+xml" title="Mark Needham" />
          
        

        <link rel="canonical" href="https://www.markhneedham.com/blog/2023/03/10/apache-pinot-geospatial-buffer-underflow/" />

    
    <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Article",
        "headline": "Apache Pinot: Geospatial - java.nio.BufferUnderflowException: null",
        "author": {
            "@type": "Person",
            "name": "http://profiles.google.com/100354797468725665406?rel=author"
        },
        "datePublished": "2023-03-10",
        "description": "I’ve been working on a blog post showing how to use Geospatial indexes in Apache Pinot and ran into an interesting exception that I’ll explain in this blog post.\nSet up But first, let’s take a look at the structure of the data that I’m ingesting from Apache Kafka. Below is an example of one of those events:\n{ \u0026#34;trainCompany\u0026#34;: \u0026#34;London Overground\u0026#34;, \u0026#34;atocCode\u0026#34;: \u0026#34;LO\u0026#34;, \u0026#34;lat\u0026#34;: 51.541615, \u0026#34;lon\u0026#34;: -0.122528896, \u0026#34;ts\u0026#34;: \u0026#34;2023-03-10 11:35:20\u0026#34;, \u0026#34;trainId\u0026#34;: \u0026#34;202303107145241\u0026#34; } As you’ve probably guessed, I’m importing the locations of trains in the UK.",
        "wordCount":  894 
    }
    </script>
    

    

<style>
*{padding:0;margin:0}body,html{font-size:1em;line-height:1.65em;font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;font-weight:300;color:#444}html{height:100%}body{padding:2em 2.5em 1em 20em}header{border-right:1px #eee solid;padding:2em;position:fixed;top:0;left:0;height:100%;width:13.5em}#content{display:block;width:100%}footer{padding:1em 0 2.5em;font-size:.8em;line-height:1.5em;color:#888}article{border-bottom:.1em #eee solid;padding-bottom:1.7em;max-width:56em}h4,h5,h6,hr,p{margin-top:.9em;margin-bottom:.9em}h1,h2,h3,h4,h5,h6{font-family:"Bree Serif",serif;font-weight:400!important}h1{font-size:2.5em;line-height:1.1em;margin-top:.6em;margin-bottom:.6em}h2{font-size:1.9em;line-height:1.2em;margin-top:.7em;margin-bottom:.7em}h3{font-size:1.4em;line-height:1.3em;margin-top:.8em;margin-bottom:.8em}h4{font-size:1.3em}h5{font-size:1.2em}h6{font-size:1.1em}iframe,img{max-width:100%}a{font-weight:700;text-decoration:none;color:#5cc265}a:hover{text-decoration:underline}h1 a,h2 a,h3 a,h4 a,h5 a,h6 a{font-weight:400!important}strong{font-weight:700}blockquote{border-left:.4em solid #008cc1;padding-left:1.2em;font-size:1.3em}hr{border:0;height:1px;background:#eee}ol,ul{margin-left:3em}code{font-size:1.1em;max-height: 500px;background:#0d1117}
pre{border-radius: .5em;font-size:.8em;line-height:1.7em;color:#c9d1d9;background:#0d1117;padding:2.0em 0.75em 2.0em 0.75em;word-break:break-all;word-wrap:break-word;white-space:pre;white-space:-moz-pre-wrap;white-space:pre-wrap}input{font-size:1em;padding:.3em}header h1{font-size:1.9em;margin-top:.8em;margin-bottom:.6em}header h1 a{color:#444}header h1 a:hover{text-decoration:none}header #logo img{width:9em;height:9em;border-radius:4.5em;-moz-border-radius:4.5em;-webkit-border-radius:4.5em;border:none}#follow-icons{font-size:.7em;margin-top:-.7em;margin-bottom:1.5em}#follow-icons a{color:#ccc}#follow-icons span{vertical-align:top;margin-left:-.15em;margin-right:-.15em}#follow-icons span .fa-stack-1x{font-size:1.05em;line-height:1.9em}header h6{margin-top:.5em}article span.post-stamp{color:#888}h1.post-title{margin-top:.35em;margin-bottom:.6em}h3.post-title{margin-top:.4em;padding-bottom:.9em;border-bottom:1px solid #eee;font-size:1.2em;color:#444}.post-title .feature-star{font-size:.9em}.feature-star,.separator,.taglist{color:#ccc}.taglist a{background-color:#008cc1;color:#fff;display:inline-block;line-height:1.5em;padding:.3em .6em;vertical-align:20%;font-size:.5em;font-family:"Open Sans",sans-serif;font-weight:700!important;text-transform:uppercase;letter-spacing:.05em;border-radius:.25em;-moz-border-radius:.25em;-webkit-border-radius:.25em}#social-bar{margin-top:1.5em;background-color:#eee;padding:.5em}#comments{margin-top:.15em;padding-bottom:.2em;border-bottom:1px solid #eee}.pagination{margin-bottom:1em}footer a{font-weight:300;color:#888;text-decoration:underline}footer a:hover{color:#444;text-decoration:none}@media only screen and (min-width:1281px){body,html{font-size:1.1em}}@media only screen and (max-width:800px){body{padding:0}header{border-right:none;border-bottom:1px #eee solid;position:relative;height:auto;width:auto;text-align:center;padding-bottom:1em}#content{margin-left:0;padding:2em 2em 1em;width:auto}footer{padding:0 2.5em 2em}}@media only screen and (max-width:320px){#content,header{padding:1.2em 1.2em .6em}footer{padding:0 1.5em 1.2em}ol,ul{margin-left:2em}}
</style>

<style>
p code{
    font-size:1.2em;
    background:#fff
}

pre.highlight {
    position: relative;
}


.label-right {
    color: #FFF;
    padding: 2px 5px;   
    border-radius: 0 0 0 0.25em;
    font-weight: 700;
    position: absolute;
    top: 0;
    right: 0;
}

.green-icon {
    color: lime;
}

.copy-button {
    cursor: pointer;  
    margin-right: 0.25em;
    padding: 0.25em 0 0 0;
}

.copy-notification {
    position: absolute;
    right: 0;
    top: 0;
    padding: 2px 5px;
    background-color: #0d1117;
    color: #fff;
}


.stretch{width:100%}
table{border-collapse:collapse;border-spacing:0}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;}
table thead,table tfoot{background:#008cc1;}
table thead tr th{background:#008cc1;}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table thead tr th {color: #ffffff;}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8);}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6;}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0; margin-top: 0;}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{margin-top: 0.5em;}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
td>div.verse{white-space:pre}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock,th.tableblock{font-size:0.8em}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#008cc1;font-weight:350;margin-top:.75em;margin-bottom:.25em}
.admonitionblock {
    margin: 0 0 1.5rem;
    border-left: 4px solid #000000;
    border-radius: .25rem;
}
.admonitionblock.note {
    background-color: #edf2f7;
    color: #19407c;
    border-left-color: #718096;
}
.admonitionblock.warning {
    background-color: #fff6e6;
    color: #19407c;
    border-left-color: #FFA500;
}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;display:none;}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}

tbody tr pre {margin-bottom: 27px}

.colist, .dlist, .exampleblock, .imageblock, .listingblock, .literalblock, .olist, .paragraph, .partintro, .quoteblock, .sidebarblock, .ulist, .verseblock {
    margin: 0 0 1.5rem;
}

.colist {
    margin: 0;
}

.colist table {
    margin: 0;
    border: none;
}

.conum { display: inline-block; color: white !important; background-color: #008cc1; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -2px; letter-spacing: -1px; }
.conum * { color: white !important; }
.conum + b { display: none; }
.conum:after { content: attr(data-value); }
.conum:not([data-value]):empty { display: none; }

.colist>table tr>td:first-of-type{ border:0; min-width:0; padding:0 .75em;}
.colist>table tr>td:last-of-type{ border:0; min-width:0; padding:.25em 0}
.colist>table tr:nth-child(even) { background:0 0 }

.listingblock + .colist {
    margin-top: -0.7rem;
}
</style>

    </head>
    <body>
        <header id="header">
            <a id="logo" href="https://www.markhneedham.com/blog/"><img src="https://www.markhneedham.com/blog//me.jpg" alt="Mark Needham" /></a>
            <h1><a href="https://www.markhneedham.com/blog/">Mark Needham</a></h1>
            <p>In this post we&#39;ll learn about the BufferUnderflowException when storing Geospatial points in Apache Pinot.</p>

            <div id="follow-icons">
	<a href="http://twitter.com/markhneedham" rel="me"><i class="fa fa-twitter-square fa-2x"></i></a>
	<a href="https://www.youtube.com/channel/UCKEk670ECmteGBehmDjVSSg" rel="me"><i class="fa fa-youtube-square fa-2x"></i></a>
	<a href="http://linkedin.com/in/markhneedham" rel="me"><i class="fa fa-linkedin-square fa-2x"></i></a>
	<a href="http://github.com/mneedham" rel="me"><i class="fa fa-github-square fa-2x"></i></a>
	<a href="mailto:m.h.needham@gmail.com"><i class="fa fa-envelope-square fa-2x"></i></a>
	<a href="https://www.markhneedham.com/blog/index.xml" rel="me"><i class="fa fa-rss-square fa-2x"></i></a>
</div>

            
        </header>

<main id="content">

<article id="" class="2023">
    <div class="post-stamp">
        <time datetime="2023-03-10T02:44:37Z">
            10 Mar 2023
        </time>
        <span class="taglist">
        
        &middot;
        
            <a href="https://www.markhneedham.com/blog/tag/pinot/">pinot</a>
        
        
        </span>
    </div>
    <h1 class="post-title">Apache Pinot: Geospatial - java.nio.BufferUnderflowException: null</h1>
    <div class="paragraph">
<p>I’ve been working on a blog post showing how to use <a href="https://dev.startree.ai/docs/pinot/recipes/geospatial-indexing?utm_source=medium&amp;utm_medium=direct&amp;utm_campaign=dr_markhneedham_emea_gb" target="_blank" rel="noopener">Geospatial indexes</a> in Apache Pinot and ran into an interesting exception that I’ll explain in this blog post.</p>
</div>
<div class="sect1">
<h2 id="_set_up">Set up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>But first, let’s take a look at the structure of the data that I’m ingesting from Apache Kafka.
Below is an example of one of those events:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  &#34;trainCompany&#34;: &#34;London Overground&#34;,
  &#34;atocCode&#34;: &#34;LO&#34;,
  &#34;lat&#34;: 51.541615,
  &#34;lon&#34;: -0.122528896,
  &#34;ts&#34;: &#34;2023-03-10 11:35:20&#34;,
  &#34;trainId&#34;: &#34;202303107145241&#34;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you’ve probably guessed, I’m importing the locations of trains in the UK.
I created the following schema:</p>
</div>
<div class="listingblock">
<div class="title">Pinot Schema</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    &#34;schemaName&#34;: &#34;trains&#34;,
    &#34;dimensionFieldSpecs&#34;: [
      {&#34;name&#34;: &#34;trainCompany&#34;, &#34;dataType&#34;: &#34;STRING&#34;},
      {&#34;name&#34;: &#34;trainId&#34;, &#34;dataType&#34;: &#34;STRING&#34;},
      {&#34;name&#34;: &#34;atocCode&#34;, &#34;dataType&#34;: &#34;STRING&#34;},
      {&#34;name&#34;: &#34;point&#34;, &#34;dataType&#34;: &#34;BYTES&#34;}
    ],
    &#34;dateTimeFieldSpecs&#34;: [
      {
        &#34;name&#34;: &#34;ts&#34;,
        &#34;dataType&#34;: &#34;TIMESTAMP&#34;,
        &#34;format&#34;: &#34;1:MILLISECONDS:EPOCH&#34;,
        &#34;granularity&#34;: &#34;1:MILLISECONDS&#34;
      }
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first three columns are automatically mapped from the data source.
The <code>point</code> column is going to store a <code>Point</code> object based on the lat/lon values in the event.
We’ll create that object in the table config, which you can see below:</p>
</div>
<div class="listingblock">
<div class="title">Pinot Table Config</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    &#34;tableName&#34;: &#34;trains&#34;,
    &#34;tableType&#34;: &#34;REALTIME&#34;,
    &#34;segmentsConfig&#34;: {
      &#34;timeColumnName&#34;: &#34;ts&#34;,
      &#34;schemaName&#34;: &#34;trains&#34;,
      &#34;replication&#34;: &#34;1&#34;,
      &#34;replicasPerPartition&#34;: &#34;1&#34;
    },
    &#34;fieldConfigList&#34;: [
      {
        &#34;name&#34;: &#34;point&#34;,
        &#34;encodingType&#34;:&#34;RAW&#34;,
        &#34;indexType&#34;:&#34;H3&#34;,
        &#34;properties&#34;: {
        &#34;resolutions&#34;: &#34;5&#34;
         }
        }
    ],
    &#34;tableIndexConfig&#34;: {
      &#34;loadMode&#34;: &#34;MMAP&#34;,
      &#34;noDictionaryColumns&#34;: [&#34;point&#34;],
      &#34;streamConfigs&#34;: {
        &#34;streamType&#34;: &#34;kafka&#34;,
        &#34;stream.kafka.topic.name&#34;: &#34;trains&#34;,
        &#34;stream.kafka.broker.list&#34;: &#34;kafka-geospatial:9093&#34;,
        &#34;stream.kafka.consumer.type&#34;: &#34;lowlevel&#34;,
        &#34;stream.kafka.consumer.prop.auto.offset.reset&#34;: &#34;smallest&#34;,
        &#34;stream.kafka.consumer.factory.class.name&#34;: &#34;org.apache.pinot.plugin.stream.kafka20.KafkaConsumerFactory&#34;,
        &#34;stream.kafka.decoder.class.name&#34;: &#34;org.apache.pinot.plugin.stream.kafka.KafkaJSONMessageDecoder&#34;,
        &#34;realtime.segment.flush.threshold.rows&#34;:&#34;1000&#34;,
        &#34;realtime.segment.flush.threshold.time&#34;:&#34;1h&#34;
      }
    },
    &#34;ingestionConfig&#34;: {
      &#34;transformConfigs&#34;: [
        {
          &#34;columnName&#34;: &#34;point&#34;,
          &#34;transformFunction&#34;: &#34;STPoint(lon, lat, 1)&#34;
        }
      ]
    },
    &#34;tenants&#34;: {},
    &#34;metadata&#34;: {}
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The function under <code>ingestionConfig.transformConfigs</code> creates a Point Geomtry object, which is stored in the <code>point</code> column.
We also create a Geospatial index on the <code>point</code> column, which is defined under <code>fieldConfigList</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_bufferunderflowexception">The BufferUnderflowException</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once I’d created this table the data started ingesting, but I was sometimes ending up with the following error on the Pinot server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">pinot-server-geospatial      | 2023/03/09 12:49:05.889 ERROR [BaseCombineOperator] [pqw-5] Caught exception while processing query: QueryContext{_tableName=&#39;trains_REALTIME&#39;, _subquery=null, _selectExpressions=[ts, trainId, atocCode, trainCompany, stastext(point)], _aliasList=[null, null, null, null, null], _filter=stwithin(point,&#39;84000000010000000600000000bfc097f3a00000004049c107e8691db8bfbbd01b7fffffff4049c10bc3b2dbd8bfbac631c00000014049bf9dcb81ef38bfc0ae8a200000014049be7fdbcf81e0bfc3b13b000000004049bf9dee86bbf8bfc097f3a00000004049c107e8691db8&#39;) = &#39;1&#39;, _groupByExpressions=null, _havingFilter=null, _orderByExpressions=[ts DESC], _limit=10, _offset=0, _queryOptions={responseFormat=sql, groupByMode=sql, timeoutMs=10000}, _expressionOverrideHints={}, _explain=false}
pinot-server-geospatial      | java.nio.BufferUnderflowException: null
pinot-server-geospatial      | 	at java.nio.Buffer.nextGetIndex(Buffer.java:643) ~[?:?]
pinot-server-geospatial      | 	at java.nio.HeapByteBuffer.get(HeapByteBuffer.java:165) ~[?:?]
pinot-server-geospatial      | 	at org.apache.pinot.segment.local.utils.GeometrySerializer.readGeometry(GeometrySerializer.java:83) ~[pinot-all-0.12.0-jar-with-dependencies.jar:0.12.0-118f5e065cb258c171d97a586183759fbc61e2bf]
pinot-server-geospatial      | 	at org.apache.pinot.segment.local.utils.GeometrySerializer.readGeometry(GeometrySerializer.java:79) ~[pinot-all-0.12.0-jar-with-dependencies.jar:0.12.0-118f5e065cb258c171d97a586183759fbc61e2bf]
pinot-server-geospatial      | 	at org.apache.pinot.segment.local.utils.GeometrySerializer.deserialize(GeometrySerializer.java:68) ~[pinot-all-0.12.0-jar-with-dependencies.jar:0.12.0-118f5e065cb258c171d97a586183759fbc61e2bf]
pinot-server-geospatial      | 	at org.apache.pinot.core.geospatial.transform.function.BaseBinaryGeoTransformFunction.transformGeometryToIntValuesSV(BaseBinaryGeoTransformFunction.java:99) ~[pinot-all-0.12.0-jar-with-dependencies.jar:0.12.0-118f5e065cb258c171d97a586183759fbc61e2bf]
pinot-server-geospatial      | 	at org.apache.pinot.core.geospatial.transform.function.StWithinFunction.transformToIntValuesSV(StWithinFunction.java:46) ~[pinot-all-0.12.0-jar-with-dependencies.jar:0.12.0-118f5e065cb258c171d97a586183759fbc61e2bf]
pinot-server-geospatial      | 	at org.apache.pinot.core.operator.dociditerators.ExpressionScanDocIdIterator.processProjectionBlock(ExpressionScanDocIdIterator.java:140) ~[pinot-all-0.12.0-jar-with-dependencies.jar:0.12.0-118f5e065cb258c171d97a586183759fbc61e2bf]
pinot-server-geospatial      | 	at org.apache.pinot.core.operator.dociditerators.ExpressionScanDocIdIterator.applyAnd(ExpressionScanDocIdIterator.java:120) ~[pinot-all-0.12.0-jar-with-dependencies.jar:0.12.0-118f5e065cb258c171d97a586183759fbc61e2bf]
pinot-server-geospatial      | 	at org.apache.pinot.core.operator.filter.H3InclusionIndexFilterOperator.getFilterBlock(H3InclusionIndexFilterOperator.java:131) ~[pinot-all-0.12.0-jar-with-dependencies.jar:0.12.0-118f5e065cb258c171d97a586183759fbc61e2bf]
pinot-server-geospatial      | 	at org.apache.pinot.core.operator.filter.H3InclusionIndexFilterOperator.getNextBlock(H3InclusionIndexFilterOperator.java:113) ~[pinot-all-0.12.0-jar-with-dependencies.jar:0.12.0-118f5e065cb258c171d97a586183759fbc61e2bf]
pinot-server-geospatial      | 	at org.apache.pinot.core.operator.filter.H3InclusionIndexFilterOperator.getNextBlock(H3InclusionIndexFilterOperator.java:49) ~[pinot-all-0.12.0-jar-with-dependencies.jar:0.12.0-118f5e065cb258c171d97a586183759fbc61e2bf]
pinot-server-geospatial      | 	at org.apache.pinot.core.operator.BaseOperator.nextBlock(BaseOperator.java:43) ~[pinot-all-0.12.0-jar-with-dependencies.jar:0.12.0-118f5e065cb258c171d97a586183759fbc61e2bf]</code></pre>
</div>
</div>
<div class="paragraph">
<p>I did a bit of debugging, which revealed that the value in the <code>point</code> column was sometimes an empty byte array.
It turns out that an empty byte array is actually the default value for the <code>BYTES</code> column type and that default value was being inserted when my transformation function failed.
And the transformation function failed if either of the lat or lon values were null!</p>
</div>
<div class="paragraph">
<p>I figured this out by running the following command against the Kafka stream:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kcat -C  -b localhost:9092 -t trains  -u  | jq &#39;select(.lat == null or .lon == null)&#39;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And eventually saw the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">{
  &#34;trainCompany&#34;: &#34;London Overground&#34;,
  &#34;atocCode&#34;: &#34;LO&#34;,
  &#34;lat&#34;: null,
  &#34;lon&#34;: null,
  &#34;ts&#34;: &#34;2023-03-10 12:56:13&#34;,
  &#34;trainId&#34;: &#34;202303107145033&#34;
}
% Reached end of topic trains [0] at offset 4475923</code></pre>
</div>
</div>
<div class="paragraph">
<p>This error was stopping any segments being committed, so I needed to fix it.
The fix that I’ve come up with is to create a default value that represents a point near the arctic as I’m fairly sure no UK trains will be going that far North!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_default_values_for_bytes_column">Default values for BYTES column</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The default value goes in the schema config and it should be a hex encoded value.
I ran the following query to get a Hex encoded representation of a location in the Arctic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">SELECT ST_GeomFromText(&#39;POINT (0.6861134172138761 83.5002942140996)&#39;)
FROM trains</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query returns the value <code>003fe5f4a42008f90c4054e004d205fbe4</code>, which I added to my schema, as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    &#34;schemaName&#34;: &#34;trains&#34;,
    &#34;dimensionFieldSpecs&#34;: [
      {&#34;name&#34;: &#34;trainCompany&#34;, &#34;dataType&#34;: &#34;STRING&#34;},
      {&#34;name&#34;: &#34;trainId&#34;, &#34;dataType&#34;: &#34;STRING&#34;},
      {&#34;name&#34;: &#34;atocCode&#34;, &#34;dataType&#34;: &#34;STRING&#34;},
      {&#34;name&#34;: &#34;point&#34;, &#34;dataType&#34;: &#34;BYTES&#34;, &#34;defaultNullValue&#34;: &#34;003fe5f4a42008f90c4054e004d205fbe4&#34;}
    ],
    &#34;dateTimeFieldSpecs&#34;: [
      {
        &#34;name&#34;: &#34;ts&#34;,
        &#34;dataType&#34;: &#34;TIMESTAMP&#34;,
        &#34;format&#34;: &#34;1:MILLISECONDS:EPOCH&#34;,
        &#34;granularity&#34;: &#34;1:MILLISECONDS&#34;
      }
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When we’re querying the table we can filter those values out like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">select $docId, $hostName, $segmentName, *
from trains
where point &lt;&gt; ST_GeomFromText(&#39;POINT (0.6861134172138761 83.5002942140996)&#39;)
limit 10</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_addtablecommand">The AddTableCommand</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When I was trying to create the schema and table from scratch with a default value, I found that I couldn’t use the <code>AddTable</code> command as it was getting into a mess by trying to decode the default value twice - once in the command itself and once on the Pinot Controller when it received the table config.
The error message looked like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">2023/03/10 13:15:04.401 INFO [AddTableCommand] [main] {&#34;code&#34;:400,&#34;error&#34;:&#34;Invalid TableConfigs. Cannot convert value: &#39;AD/l9KQgCPkMQFTgBNIF++Q=&#39; to type: BYTES\n at [Source: (String)\&#34;{\&#34;tableName\&#34;:\&#34;trains\&#34;,\&#34;schema\&#34;:{\&#34;schemaName\&#34;:\&#34;trains\&#34;,\&#34;primaryKeyColumns\&#34;:null,\&#34;dimensionFieldSpecs\&#34;:[{\&#34;name\&#34;:\&#34;trainCompany\&#34;,\&#34;maxLength\&#34;:512,\&#34;dataType\&#34;:\&#34;STRING\&#34;,\&#34;transformFunction\&#34;:null,\&#34;defaultNullValue\&#34;:\&#34;null\&#34;,\&#34;singleValueField\&#34;:true,\&#34;virtualColumnProvider\&#34;:null,\&#34;defaultNullValueString\&#34;:\&#34;null\&#34;},{\&#34;name\&#34;:\&#34;trainId\&#34;,\&#34;maxLength\&#34;:512,\&#34;dataType\&#34;:\&#34;STRING\&#34;,\&#34;transformFunction\&#34;:null,\&#34;defaultNullValue\&#34;:\&#34;null\&#34;,\&#34;singleValueField\&#34;:true,\&#34;virtualColumnProvider\&#34;:null,\&#34;defaultNullValueString\&#34;:\&#34;null\&#34;},{\&#34;name\&#34;:\&#34;at\&#34;[truncated 2231 chars]; line: 1, column: 777] (through reference chain: org.apache.pinot.spi.config.TableConfigs[\&#34;schema\&#34;]-&gt;org.apache.pinot.spi.data.Schema[\&#34;dimensionFieldSpecs\&#34;]-&gt;java.util.ArrayList[3]-&gt;org.apache.pinot.spi.data.DimensionFieldSpec[\&#34;defaultNullValue\&#34;])&#34;}</code></pre>
</div>
</div>
<div class="paragraph">
<p>I’m not really sure how to get this to work, but luckily there is a workaround.
First, create the schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run \
   --network geospatial \
   -v $PWD/config:/config \
   apachepinot/pinot:0.12.0-arm64 AddSchema \
     -schemaFile /config/schema.json \
     -controllerHost &#34;pinot-controller-geospatial&#34; \
    -exec</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then create the table using the HTTP API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -X POST http://localhost:9000/tables --data @config/table.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Not ideal, but it works!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This ended up being super fiddly, but it does work!
If you’re stuck on something similar, do join the <a href="https://dev.startree.ai/slack-invite?utm_source=medium&amp;utm_medium=direct&amp;utm_campaign=dr_markhneedham_emea_gb" target="_blank" rel="noopener">StarTree Community Slack</a> and I’ll do my best to help.</p>
</div>
</div>
</div>

    <div id="social-bar">
	<ul class="rrssb-buttons clearfix">
      <li class="email">
          <a href="mailto:?subject=Apache%20Pinot%3a%20Geospatial%20-%20java.nio.BufferUnderflowException%3a%20null&amp;body=https://www.markhneedham.com/blog/2023/03/10/apache-pinot-geospatial-buffer-underflow/">
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
                      <path transform="scale(0.014,-0.014) translate(0,-1670)" d="M1792 826v-794q0 -66 -47 -113t-113 -47h-1472q-66 0 -113 47t-47 113v794q44 -49 101 -87q362 -246 497 -345q57 -42 92.5 -65.5t94.5 -48t110 -24.5h1h1q51 0 110 24.5t94.5 48t92.5 65.5q170 123 498 345q57 39 100 87zM1792 1120q0 -79 -49 -151t-122 -123 q-376 -261 -468 -325q-10 -7 -42.5 -30.5t-54 -38t-52 -32.5t-57.5 -27t-50 -9h-1h-1q-23 0 -50 9t-57.5 27t-52 32.5t-54 38t-42.5 30.5q-91 64 -262 182.5t-205 142.5q-62 42 -117 115.5t-55 136.5q0 78 41.5 130t118.5 52h1472q65 0 112.5 -47t47.5 -113z"/>
                  </svg>
              </span>
              <span class="text">Email</span>
          </a>
      </li>
      <li class="facebook">
          <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.markhneedham.com/blog/2023/03/10/apache-pinot-geospatial-buffer-underflow/" class="popup">
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
                      <path d="M27.825,4.783c0-2.427-2.182-4.608-4.608-4.608H4.783c-2.422,0-4.608,2.182-4.608,4.608v18.434 c0,2.427,2.181,4.608,4.608,4.608H14V17.379h-3.379v-4.608H14v-1.795c0-3.089,2.335-5.885,5.192-5.885h3.718v4.608h-3.726 c-0.408,0-0.884,0.492-0.884,1.236v1.836h4.609v4.608h-4.609v10.446h4.916c2.422,0,4.608-2.188,4.608-4.608V4.783z"/>
                  </svg>
              </span>
              <span class="text">Facebook</span>
          </a>
      </li>
			<li class="twitter">
          <a href="http://twitter.com/home?status=Apache%20Pinot%3a%20Geospatial%20-%20java.nio.BufferUnderflowException%3a%20null%20https://www.markhneedham.com/blog/2023/03/10/apache-pinot-geospatial-buffer-underflow/" class="popup">
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
		                  <path d="M24.253,8.756C24.689,17.08,18.297,24.182,9.97,24.62c-3.122,0.162-6.219-0.646-8.861-2.32 c2.703,0.179,5.376-0.648,7.508-2.321c-2.072-0.247-3.818-1.661-4.489-3.638c0.801,0.128,1.62,0.076,2.399-0.155 C4.045,15.72,2.215,13.6,2.115,11.077c0.688,0.275,1.426,0.407,2.168,0.386c-2.135-1.65-2.729-4.621-1.394-6.965 C5.575,7.816,9.54,9.84,13.803,10.071c-0.842-2.739,0.694-5.64,3.434-6.482c2.018-0.623,4.212,0.044,5.546,1.683 c1.186-0.213,2.318-0.662,3.329-1.317c-0.385,1.256-1.247,2.312-2.399,2.942c1.048-0.106,2.069-0.394,3.019-0.851 C26.275,7.229,25.39,8.196,24.253,8.756z"/>
                  </svg>
              </span>
              <span class="text">Twitter</span>
          </a>
      </li>
			<li class="linkedin">
          <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=https://www.markhneedham.com/blog/2023/03/10/apache-pinot-geospatial-buffer-underflow/&amp;title=Apache%20Pinot%3a%20Geospatial%20-%20java.nio.BufferUnderflowException%3a%20null&amp;summary=I%e2%80%99ve%20been%20working%20on%20a%20blog%20post%20showing%20how%20to%20use%20Geospatial%20indexes%20in%20Apache%20Pinot%20and%20ran%20into%20an%20interesting%20exception%20that%20I%e2%80%99ll%20explain%20in%20this%20blog%20post.%0aSet%20up%20But%20first%2c%20let%e2%80%99s%20take%20a%20look%20at%20the%20structure%20of%20the%20data%20that%20I%e2%80%99m%20ingesting%20from%20Apache%20Kafka.%20Below%20is%20an%20example%20of%20one%20of%20those%20events%3a%0a%7b%20%26%2334%3btrainCompany%26%2334%3b%3a%20%26%2334%3bLondon%20Overground%26%2334%3b%2c%20%26%2334%3batocCode%26%2334%3b%3a%20%26%2334%3bLO%26%2334%3b%2c%20%26%2334%3blat%26%2334%3b%3a%2051.541615%2c%20%26%2334%3blon%26%2334%3b%3a%20-0.122528896%2c%20%26%2334%3bts%26%2334%3b%3a%20%26%2334%3b2023-03-10%2011%3a35%3a20%26%2334%3b%2c%20%26%2334%3btrainId%26%2334%3b%3a%20%26%2334%3b202303107145241%26%2334%3b%20%7d%20As%20you%e2%80%99ve%20probably%20guessed%2c%20I%e2%80%99m%20importing%20the%20locations%20of%20trains%20in%20the%20UK...." class="popup">
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
                      <path d="M25.424,15.887v8.447h-4.896v-7.882c0-1.979-0.709-3.331-2.48-3.331c-1.354,0-2.158,0.911-2.514,1.803 c-0.129,0.315-0.162,0.753-0.162,1.194v8.216h-4.899c0,0,0.066-13.349,0-14.731h4.899v2.088c-0.01,0.016-0.023,0.032-0.033,0.048 h0.033V11.69c0.65-1.002,1.812-2.435,4.414-2.435C23.008,9.254,25.424,11.361,25.424,15.887z M5.348,2.501 c-1.676,0-2.772,1.092-2.772,2.539c0,1.421,1.066,2.538,2.717,2.546h0.032c1.709,0,2.771-1.132,2.771-2.546 C8.054,3.593,7.019,2.501,5.343,2.501H5.348z M2.867,24.334h4.897V9.603H2.867V24.334z"/>
                  </svg>
              </span>
              <span class="text">LinkedIn</span>
          </a>
      </li>
      <li class="tumblr">
					<script>
						document.write('<a href="http://www.tumblr.com/share?v=3&amp;u=' + encodeURIComponent('https:\/\/www.markhneedham.com\/blog\/2023\/03\/10\/apache-pinot-geospatial-buffer-underflow\/') + '&amp;t=Apache Pinot: Geospatial - java.nio.BufferUnderflowException: null" class="popup">');
					</script>
              <span class="icon">
                  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
											<path d="M18.02 21.842c-2.029 0.052-2.422-1.396-2.439-2.446v-7.294h4.729V7.874h-4.71V1.592c0 0-3.653 0-3.714 0 s-0.167 0.053-0.182 0.186c-0.218 1.935-1.144 5.33-4.988 6.688v3.637h2.927v7.677c0 2.8 1.7 6.7 7.3 6.6 c1.863-0.03 3.934-0.795 4.392-1.453l-1.22-3.539C19.595 21.6 18.7 21.8 18 21.842z"/>
									</svg>
              </span>
              <span class="text">Tumblr</span>
          <script>document.write('</a>');</script>
      </li>
      <li class="reddit">
          <a href="http://www.reddit.com/submit?url=https://www.markhneedham.com/blog/2023/03/10/apache-pinot-geospatial-buffer-underflow/">
              <span class="icon">
                  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
											<g>
													<path d="M11.794 15.316c0-1.029-0.835-1.895-1.866-1.895c-1.03 0-1.893 0.865-1.893 1.895s0.863 1.9 1.9 1.9 C10.958 17.2 11.8 16.3 11.8 15.316z"/>
													<path d="M18.1 13.422c-1.029 0-1.895 0.864-1.895 1.895c0 1 0.9 1.9 1.9 1.865c1.031 0 1.869-0.836 1.869-1.865 C19.969 14.3 19.1 13.4 18.1 13.422z"/>
													<path d="M17.527 19.791c-0.678 0.678-1.826 1.006-3.514 1.006c-0.004 0-0.009 0-0.014 0c-0.004 0-0.01 0-0.015 0 c-1.686 0-2.834-0.328-3.51-1.005c-0.264-0.265-0.693-0.265-0.958 0c-0.264 0.265-0.264 0.7 0 1 c0.943 0.9 2.4 1.4 4.5 1.402c0.005 0 0 0 0 0c0.005 0 0 0 0 0c2.066 0 3.527-0.459 4.47-1.402 c0.265-0.264 0.265-0.693 0.002-0.958C18.221 19.5 17.8 19.5 17.5 19.791z"/>
													<path d="M27.707 13.267c0-1.785-1.453-3.237-3.236-3.237c-0.793 0-1.518 0.287-2.082 0.761c-2.039-1.295-4.646-2.069-7.438-2.219 l1.483-4.691l4.062 0.956c0.071 1.4 1.3 2.6 2.7 2.555c1.488 0 2.695-1.208 2.695-2.695C25.881 3.2 24.7 2 23.2 2 c-1.059 0-1.979 0.616-2.42 1.508l-4.633-1.091c-0.344-0.081-0.693 0.118-0.803 0.455l-1.793 5.7 C10.548 8.6 7.7 9.4 5.6 10.75C5.006 10.3 4.3 10 3.5 10.029c-1.785 0-3.237 1.452-3.237 3.2 c0 1.1 0.6 2.1 1.4 2.69c-0.04 0.272-0.061 0.551-0.061 0.831c0 2.3 1.3 4.4 3.7 5.9 c2.299 1.5 5.3 2.3 8.6 2.325c3.228 0 6.271-0.825 8.571-2.325c2.387-1.56 3.7-3.66 3.7-5.917 c0-0.26-0.016-0.514-0.051-0.768C27.088 15.5 27.7 14.4 27.7 13.267z M23.186 3.355c0.74 0 1.3 0.6 1.3 1.3 c0 0.738-0.6 1.34-1.34 1.34s-1.342-0.602-1.342-1.34C21.844 4 22.4 3.4 23.2 3.355z M1.648 13.3 c0-1.038 0.844-1.882 1.882-1.882c0.31 0 0.6 0.1 0.9 0.209c-1.049 0.868-1.813 1.861-2.26 2.9 C1.832 14.2 1.6 13.8 1.6 13.267z M21.773 21.57c-2.082 1.357-4.863 2.105-7.831 2.105c-2.967 0-5.747-0.748-7.828-2.105 c-1.991-1.301-3.088-3-3.088-4.782c0-1.784 1.097-3.484 3.088-4.784c2.081-1.358 4.861-2.106 7.828-2.106 c2.967 0 5.7 0.7 7.8 2.106c1.99 1.3 3.1 3 3.1 4.784C24.859 18.6 23.8 20.3 21.8 21.57z M25.787 14.6 c-0.432-1.084-1.191-2.095-2.244-2.977c0.273-0.156 0.59-0.245 0.928-0.245c1.035 0 1.9 0.8 1.9 1.9 C26.354 13.8 26.1 14.3 25.8 14.605z"/>
											</g>
									</svg>
              </span>
              <span class="text">Reddit</span>
          </a>
      </li>
      <li class="googleplus">
          <a href="https://plus.google.com/share?url=https://www.markhneedham.com/blog/2023/03/10/apache-pinot-geospatial-buffer-underflow/" class="popup">
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
                      <g>
                          <path d="M14.703,15.854l-1.219-0.948c-0.372-0.308-0.88-0.715-0.88-1.459c0-0.748,0.508-1.223,0.95-1.663 c1.42-1.119,2.839-2.309,2.839-4.817c0-2.58-1.621-3.937-2.399-4.581h2.097l2.202-1.383h-6.67c-1.83,0-4.467,0.433-6.398,2.027 C3.768,4.287,3.059,6.018,3.059,7.576c0,2.634,2.022,5.328,5.604,5.328c0.339,0,0.71-0.033,1.083-0.068 c-0.167,0.408-0.336,0.748-0.336,1.324c0,1.04,0.551,1.685,1.011,2.297c-1.524,0.104-4.37,0.273-6.467,1.562 c-1.998,1.188-2.605,2.916-2.605,4.137c0,2.512,2.358,4.84,7.289,4.84c5.822,0,8.904-3.223,8.904-6.41 c0.008-2.327-1.359-3.489-2.829-4.731H14.703z M10.269,11.951c-2.912,0-4.231-3.765-4.231-6.037c0-0.884,0.168-1.797,0.744-2.511 c0.543-0.679,1.489-1.12,2.372-1.12c2.807,0,4.256,3.798,4.256,6.242c0,0.612-0.067,1.694-0.845,2.478 c-0.537,0.55-1.438,0.948-2.295,0.951V11.951z M10.302,25.609c-3.621,0-5.957-1.732-5.957-4.142c0-2.408,2.165-3.223,2.911-3.492 c1.421-0.479,3.25-0.545,3.555-0.545c0.338,0,0.52,0,0.766,0.034c2.574,1.838,3.706,2.757,3.706,4.479 c-0.002,2.073-1.736,3.665-4.982,3.649L10.302,25.609z"/>
                          <polygon points="23.254,11.89 23.254,8.521 21.569,8.521 21.569,11.89 18.202,11.89 18.202,13.604 21.569,13.604 21.569,17.004 23.254,17.004 23.254,13.604 26.653,13.604 26.653,11.89"/>
                      </g>
                  </svg>
              </span>
              <span class="text">Google+</span>
          </a>
      </li>
      <li class="pinterest">
          <script>
						var imgurl = "https:\/\/www.markhneedham.com\/blog\/logo.png";
						var firstimg = document.getElementsByClassName("2023")[0].getElementsByTagName("img")[0];
						if (firstimg !== undefined) {
							imgurl = firstimg.src;
						}
						document.write('<a href="http://pinterest.com/pin/create/button/?url=https:\/\/www.markhneedham.com\/blog\/2023\/03\/10\/apache-pinot-geospatial-buffer-underflow\/&amp;media=' + imgurl + '&amp;description=Apache Pinot: Geospatial - java.nio.BufferUnderflowException: null" class="popup">');
					</script>
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
		                  <path d="M14.021,1.57C6.96,1.57,1.236,7.293,1.236,14.355c0,7.062,5.724,12.785,12.785,12.785c7.061,0,12.785-5.725,12.785-12.785 C26.807,7.294,21.082,1.57,14.021,1.57z M15.261,18.655c-1.161-0.09-1.649-0.666-2.559-1.219c-0.501,2.626-1.113,5.145-2.925,6.458 c-0.559-3.971,0.822-6.951,1.462-10.116c-1.093-1.84,0.132-5.545,2.438-4.632c2.837,1.123-2.458,6.842,1.099,7.557 c3.711,0.744,5.227-6.439,2.925-8.775c-3.325-3.374-9.678-0.077-8.897,4.754c0.19,1.178,1.408,1.538,0.489,3.168 C7.165,15.378,6.53,13.7,6.611,11.462c0.131-3.662,3.291-6.227,6.46-6.582c4.007-0.448,7.771,1.474,8.29,5.239 c0.579,4.255-1.816,8.865-6.102,8.533L15.261,18.655z"/>
                  </svg>
              </span>
              <span class="text">Pinterest</span>
          <script>document.write('</a>');</script>
      </li>
      <li class="pocket">
          <a href="https://getpocket.com/save?url=https://www.markhneedham.com/blog/2023/03/10/apache-pinot-geospatial-buffer-underflow/"  class="popup">
              <span class="icon">
                  <svg width="32px" height="28px" viewBox="0 0 32 28" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                      <path d="M28.7817528,0.00172488695 C30.8117487,0.00431221738 31.9749312,1.12074529 31.9644402,3.10781507 C31.942147,6.67703739 32.1336065,10.2669583 31.8057648,13.8090137 C30.7147076,25.5813672 17.2181194,31.8996281 7.20714461,25.3808491 C2.71833574,22.4571656 0.196577202,18.3122624 0.0549495772,12.9357897 C-0.0342233715,9.5774348 0.00642900214,6.21519891 0.0300336062,2.85555035 C0.0405245414,1.1129833 1.21157517,0.0146615391 3.01995012,0.00819321302 C7.34746087,-0.00603710433 11.6775944,0.00431221738 16.0064164,0.00172488695 C20.2644248,0.00172488695 24.5237444,-0.00215610869 28.7817528,0.00172488695 L28.7817528,0.00172488695 Z M8.64885184,7.85611511 C7.38773662,7.99113854 6.66148108,8.42606978 6.29310958,9.33228474 C5.90114134,10.2969233 6.17774769,11.1421181 6.89875951,11.8276216 C9.35282156,14.161969 11.8108164,16.4924215 14.2976518,18.7943114 C15.3844131,19.7966007 16.5354102,19.7836177 17.6116843,18.7813283 C20.0185529,16.5495467 22.4070683,14.2982907 24.7824746,12.0327533 C25.9845979,10.8850542 26.1012707,9.56468083 25.1469132,8.60653379 C24.1361858,7.59255976 22.8449191,7.6743528 21.5890476,8.85191291 C19.9936451,10.3488554 18.3680912,11.8172352 16.8395462,13.3777945 C16.1342655,14.093159 15.7200114,14.0048744 15.0566806,13.3440386 C13.4599671,11.7484252 11.8081945,10.2060421 10.1262706,8.70001155 C9.65564653,8.27936164 9.00411403,8.05345704 8.64885184,7.85611511 L8.64885184,7.85611511 L8.64885184,7.85611511 Z"></path>
                  </svg>
              </span>
              <span class="text">Pocket</span>
          </a>
      </li>
  </ul>
</div>

    <div itemprop="author" itemscope itemtype="http://schema.org/Person">
  <h5>About the author</h5>
  <section>
    <p><a href="https://twitter.com/markhneedham" itemprop="name" rel="author">I'm</a> currently working on real-time user-facing analytics with <a href="https://pinot.apache.org/">Apache Pinot</a> at <a href="https://www.startree.ai/">StarTree</a>. I publish short 5 minute videos showing how to solve data problems on YouTube <a href="https://www.youtube.com/@LearnDataWithMark">@LearnDataWithMark</a>. I previously worked on graph analytics at <a href="https://neo4j.com/">Neo4j</a>, where I also I co-authored the <a href="https://neo4j.com/graph-algorithms-book">O'Reilly Graph Algorithms Book</a> with Amy Hodler.</p>
  </section>
</div>

    <div id="comments">
    
    
    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname = 'markhneedham';
      var disqus_identifier = 'https:\/\/www.markhneedham.com\/blog\/2023\/03\/10\/apache-pinot-geospatial-buffer-underflow\/';
      var disqus_title = 'Apache Pinot: Geospatial - java.nio.BufferUnderflowException: null';
      var disqus_url = 'https:\/\/www.markhneedham.com\/blog\/2023\/03\/10\/apache-pinot-geospatial-buffer-underflow\/';
      (function() {
        if (window.location.hostname == "localhost")
                return;

        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
    
</div>

</article>

</main>

  <footer id="footer">
			<section id="footer-message">&copy; Mark Needham. All rights reserved. Powered by <a href="http://gohugo.io" target="_blank">Hugo</a>. <a href="https://github.com/kathyqian/crisp-ghost-theme" target="_blank">Crisp</a> theme by <a href="http://kathyqian.com" target="_blank">Kathy Qian</a>.</section>
		</footer>

    <script>
      (function(c,f){asyncLoader=function(i,h){i.foreach(function(k,j){e(j,d(j),h)});if(typeof h.callback=="function"){var g=setInterval(function(){if(f.readyState==="complete"){clearInterval(g);h.callback()}},10)}};var d=function(g){var h=g.split(".");return h[h.length-1]},e=function(h,i,g){switch(i){case"js":a(h,g);break;case"css":b(h);break;default:break}},a=function(i,h){var g=document.createElement("script");g.type="text/javascript";g.async=true;g.src=i;document.getElementsByTagName("head")[0].appendChild(g)},b=function(g){var h=document.createElement("link");h.type="text/css";h.rel="stylesheet";h.href=g;document.getElementsByTagName("head")[0].appendChild(h)};Array.prototype.foreach=function(h){for(var g=0;g<this.length;g++){h(g,this[g])}}})(this,document);

      var WebFontConfig={google:{families:["Open Sans:300italic,700italic,300,700","Bree+Serif"]}};
      asyncLoader([
        "//netdna.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.css",
        "//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js",
        "//cdnjs.cloudflare.com/ajax/libs/webfont/1.5.16/webfontloader.js",
        "//unpkg.com/@highlightjs/cdn-assets@10.7.2/highlight.min.js"        
      ],{
        callback:function(){
          asyncLoader([
            "https:\/\/www.markhneedham.com\/blog\/css/rrssb.css",
            "https:\/\/www.markhneedham.com\/blog\/css/github-dark.css",
            "https:\/\/www.markhneedham.com\/blog\/js/image-zoom.js",
            "https:\/\/www.markhneedham.com\/blog\/js/gist.min.js",
            "https:\/\/www.markhneedham.com\/blog\/js/rrssb.min.js",
            "https://unpkg.com/highlightjs-cypher/dist/cypher.min.js",            
          ], { callback:function() {
              
              document.querySelectorAll('pre code').forEach((block) => {
                  hljs.highlightElement(block);                  
                  
                  var language = block.result.language;
                  if(language && language !== "text") {             
                    const originalCode = block.textContent.trim(); 
                    const labelAndButtonHTML = `
                      <span class="label-and-button">
                        <label class="label-right">${language.toUpperCase()}</label>
                        <i class="copy-button fa fa-copy"></i>
                      </span>
                    `;
                    block.insertAdjacentHTML("afterbegin", `<label class="label-right">${language.toUpperCase()} <i class="copy-button fa fa-copy"></i></label>`);

                    const button = block.querySelector('.copy-button');
                    button.addEventListener('click', (event) => {
                        var code = button.parentElement.textContent;
                        navigator.clipboard.writeText(originalCode).then(function() {
                          button.classList.remove('fa-copy');  // Remove the copy icon class
                          button.classList.add('fa-check', 'green-icon');  

                          setTimeout(function() {
                              button.classList.remove('fa-check', 'green-icon');  
                              button.classList.add('fa-copy');  
                          }, 2000);
                        }, function(err) {
                             
                            console.error('Could not copy code to clipboard: ', err);
                        });
                    });
                  }                  
              });
          }});
        }
      });
    </script>
	
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-KVLB7W6R20"></script>
		<script>
		  window.dataLayer = window.dataLayer || [];
		  function gtag(){dataLayer.push(arguments);}
		  gtag('js', new Date());

		  gtag('config', 'G-KVLB7W6R20');
    </script>

    

    


  
	</body>
</html>

