+++
draft = false
date="2013-03-24 22:52:19"
title="Incrementally rolling out machines with a new puppet role"
tag=['devops-2']
category=['DevOps']
+++

<p>Last week <a href="https://twitter.com/jasonneylon">Jason</a> and I with (a lot of) help from <a href="https://twitter.com/timrgoodwin">Tim</a> have been working on moving several of our applications from <a href="https://twitter.com/jasonneylon">Passenger</a> to <a href="https://github.com/blog/517-unicorn">Unicorn</a> and decided that the easiest way to do this was to create a new set of nodes with this setup.</p>


<p>The architecture we're working with looks like this at a VM level:</p>


<div align="center">
<img src="http://www.markhneedham.com/blog/wp-content/uploads/2013/03/architecture.png" alt="Architecture" title="architecture.png" border="0" width="600" height="349" />
</div>

<p>The 'nginx LB' nodes are responsible for routing all the requests to their appropriate application servers and the 'web' nodes serve the different applications initially using Passenger.</p>


<p>We started off by creating a new 'nginx LB' node which we pointed to a new 'web ELB' and just put one 'unicorn web' node behind it so that we could test everything was working.</p>


<p>We then pointed 'www.uswitch.com' at the IP of our new 'nginx LB' node in our <cite>/etc/hosts</cite> file and checked that the main flows through the various applications were working correctly.</p>


<p>Once we were happy this was working correctly we increased the number of 'unicorn web' nodes to three and then repeated our previous checks while tailing the log files across the three machines to make sure everything was ok.</p>


<p>The next step was to send some of the real traffic to the new nodes and check whether they were able to handle it.</p>


<p>Initially we thought that we could put our 'unicorn web' nodes alongside the 'web' nodes but we realised that we'd made some changes on our new 'nginx LB' nodes which meant that the 'unicorn web' nodes needed to receive requests proxies through there rather than from the old style node.</p>


<p>A combination of Jason and <a href="https://twitter.com/siddharthdawara">Sid</a> came up with the idea of just plugging our new 'nginx LB' into the 'nginx ELB' and having the processing of the  whole request treated separately.</p>


<p>Our intermediate architecture therefore looked like this:</p>


<div align="center">
<img src="http://www.markhneedham.com/blog/wp-content/uploads/2013/03/arhictecture-rollover.png" alt="Arhictecture rollover" title="arhictecture-rollover.png" border="0" width="600" height="357" />
</div>

<p>We initially served 1/4 of the requests from the Unicorn and watched the performance of the nodes via <a href="http://newrelic.com/">New Relic</a> to check that everything was working expected.</p>


<p>One thing we did notice was that the CPU usage on the Unicorn nodes was really high because we'd set up each Unicorn process with 5 workers which meant that we had 25 workers on the VM in total. In comparison our Passenger instances used 5 workers in total.</p>


<p>Once we'd sorted that out we removed one of the 'nginx LB' nodes from the 'nginx ELB' and served 1/3 of the traffic from our new stack.</p>


<p>We didn't see any problems so we removed all the 'nginx LB' nodes and served all the traffic from our new stack for half an hour.</p>


<p>Again we didn't notice any problems so our next step before we can decommission the old nodes is to run the new stack for a day and iron out any problems before using it for real.</p>

